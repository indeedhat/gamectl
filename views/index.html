{{ define "content" }}

<link rel="stylesheet" href="/assets/js/lib/codemirror/lib/codemirror.css" />
<link rel="stylesheet" href="/assets/js/lib/codemirror/theme/darcula.css" />
<script src="/assets/js/lib/codemirror/lib/codemirror.js"></script>

<div class="bodyTitle">> Main Controls</div>
<div class="body">
    <div id="resource-monitor">
        <div class="error">
            Kag, this really needs making pretty
            <br />
            HELP!
        </div>
        <div class="data"></div>
    </div>
    <script type="module">
        import ResourceMonitor from '/assets/js/resource-monitor.js';
        new ResourceMonitor("#resource-monitor");
    </script>

    {{ range $key, $app := .apps }}
        <div 
            class="serverStatus" 
            data-key="{{ $key }}" 
            data-config="{{ json $app.ConfigFiles }}"
            data-logs="{{ json $app.LogFiles }}"
        >
            <div class="serverTitle">> {{ $app.Title }}</div>

            <div class="dataContainer">
                <div class="dataTile statusLabel">Status  :</div>  
                <div class="dataTile status"> Fixme</div>

                <div class="dataTile playersLabel">Players :</div>  
                <div class="dataTile players" > 
                    <span class="current">Fixme</span>/<span class="max">{{ $app.MaxPlayers }}</span>
                </div>

                <div class="dataTile uptimeLabel">Uptime  :</div>  
                <div class="dataTile uptime"> fixme</div>

            </div>
            <img class="icon" src="{{ $app.Icon }}">
            <div class="controls">
                <button class="controller startStop">Stop</button>
                <button class="controller restart" disabled>Restart</button>
                <button class="controller config" disabled>Config</button>
                <button class="controller logs" disabled>Logs</button>
                <button class="controller download" disabled>Download World</button>
            </div>
        </div>
        <script type="module">
            import { get, post } from "/assets/js/request.js";
            import { minDuration } from "/assets/js/util.js";
            import { initDownloadButton } from "/assets/js/world-download.js";
            import AppConfig from '/assets/js/app-config.js';

            const appKey = '{{ $key }}';

            new AppConfig('{{ $app.Title }}', appKey);

            let $button = document.querySelector(`.serverStatus[data-key='${appKey}'] .controller.download`);
            {{ if $app.WorldDirectory }}
                $button.removeAttribute("disabled");
            {{ end }}

            initDownloadButton(appKey, $button);

            const $app = document.querySelector(`.serverStatus[data-key='${appKey}']`);
            const $status = $app.querySelector(".dataTile.status");
            const $players = $app.querySelector(".dataTile.players");
            const $uptime = $app.querySelector(".dataTile.uptime");

            const $startStopButton = $app.querySelector(".controller.startStop");
            const $restartButton = $app.querySelector(".controller.restart");

            const getStatus = async () => {
                let [code, json] = await get(`/api/apps/${appKey}`)
                if (!json.outcome) {
                    return;
                }

                if (json.status.online) {
                    $status.classList.add("online");
                    $status.classList.remove("offline");

                    $startStopButton.innerHTML = "Stop";
                    $startStopButton.onclick = stopServer;

                    $restartButton.removeAttribute("disabled");
                    $restartButton.onclick = restartServer;
                } else {
                    $status.classList.remove("online");
                    $status.classList.add("offline");

                    $startStopButton.innerHTML = "Start";
                    $startStopButton.onclick = startServer;

                    $restartButton.setAttribute("disabled", true);
                }

                $status.innerHTML = json.status.online ? "Online" : "Offline";
                $players.querySelector(".current").innerHTML = json.status.users;
                $uptime.innerHTML = minDuration(json.status.uptime);
            };

            const startServer = async () => {
                $startStopButton.innerHTML = "Starting...";
                try {
                    let [code, json] = await post(`/api/apps/${appKey}/start`, {})
                    if (!json.outcome) {
                        throw new Error();
                    }

                    getStatus();
                } catch (e) {
                    $startStopButton.innerHTML = "Start Failed!";
                }
            };

            const stopServer = async () => {
                $startStopButton.innerHTML = "Stopping...";
                try {
                    let [code, json] = await post(`/api/apps/${appKey}/stop`, {})
                    if (!json.outcome) {
                        throw new Error();
                    }

                    getStatus();
                } catch (e) {
                    $startStopButton.innerHTML = "Stop Failed!";
                }
            };

            const restartServer = async () => {
                $startStopButton.innerHTML = "Restarting...";
                try {
                    let [code, json] = await post(`/api/apps/${appKey}/restart`, {})
                    if (!json.outcome) {
                        throw new Error();
                    }

                    getStatus();
                } catch (e) {
                    $startStopButton.innerHTML = "Restart Failed!";
                }
            };

            getStatus();
            setTimeout(getStatus, 60000)
        </script>

        <script>update_css()</script>
    {{ end }}

    <div class="clearfix"></div>
</div>

<!-- Begin Test -->

<!-- End Test -->


{{ end }}
